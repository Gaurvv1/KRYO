<script>
/*
  Frontend script for Kryo:
  - collects controls from the page
  - builds the payload (shape above)
  - POSTs to /api/generate-meme
  - shows the JSON response in the "out" <pre>
*/

/* Helpers */
const $ = id => document.getElementById(id);
let regenCount = 0;

// safe default getters (works even if advanced controls not present)
function getValueOr(id, fallback) {
  const el = document.getElementById(id);
  if (!el) return fallback;
  if (el.type === 'checkbox') return el.checked;
  return el.value || fallback;
}

async function callGenerate() {
  // Collect values from UI. Make sure your index.html has inputs with these IDs
  const imageUrl = getValueOr('uploadedImageUrl',''); // optional hidden input if you implement uploads
  const labels = getValueOr('labels','');             // optional, server can compute
  const text_context = getValueOr('textIn','').trim();
  const vibe = getValueOr('vibe','funny');
  const length = getValueOr('mLength','medium');
  const color_mode = getValueOr('colorMode','auto');
  const primary_color = getValueOr('primaryColor','#FFD700');
  const secondary_color = getValueOr('secondaryColor','#8A2BE2');
  const shade_intensity = parseFloat(getValueOr('shade','0.6')) || 0.6;
  const direct_generate = getValueOr('directToggle', false);
  const regenerate_count = regenCount;

  const payload = {
    imageUrl,
    labels,
    text_context,
    vibe,
    length,
    color_mode,
    primary_color,
    secondary_color,
    shade_intensity,
    direct_generate,
    regenerate_count
  };

  // show loading
  const out = $('out');
  out.textContent = 'Generating...';

  try {
    const res = await fetch('/api/generate-meme', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    out.textContent = JSON.stringify(json, null, 2);

    // increment regen counter only on successful call (so next regen differs)
    regenCount++;

    // If server returned meme_text and overlay_style, you can call a render function here
    // e.g. renderOverlayOnCanvas(json.meme_text, json.overlay_style)
  } catch (err) {
    out.textContent = 'Network or server error: ' + (err.message || err);
  }
}

/* wire the button (your index.html has button id="genBtn") */
const genBtn = $('genBtn');
if (genBtn) {
  genBtn.addEventListener('click', () => {
    callGenerate();
  });
}

/* If you want a regenerate button separately, use:
   const regenBtn = $('regenerateBtn'); regenBtn.onclick = callGenerate;
*/
</script>
